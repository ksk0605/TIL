## 서킷 브레이커 기술 요약

### 1. 목적

외부 서비스와의 연동 시, 특정 서비스의 장애(느린 응답, 에러)가 호출하는 클라이언트 시스템 전체로 전파되어 시스템 전체가 마비되는 연쇄 실패(Cascading Failure)를 방지하는 것을 주 목적으로 한다.

### 2. 핵심 동작 원리

서킷 브레이커는 다음 세 가지 상태를 가지며, 설정된 규칙에 따라 상태를 자동으로 전환한다.

-   **`CLOSED` (닫힘)**
    -   **동작:** 모든 요청을 정상적으로 전달한다.
    -   **상태 유지:** 슬라이딩 윈도우 내의 호출 결과를 모니터링하며 실패율 및 느린 호출 비율을 집계한다.
    -   **전환 조건:** 집계된 실패율 또는 느린 호출 비율이 설정된 임계값(`threshold`)을 초과하면 `OPEN` 상태로 전환된다.

-   **`OPEN` (열림)**
    -   **동작:** 외부 서비스로의 요청을 즉시 차단하고 `CallNotPermittedException`을 발생시킨다. Fallback이 설정된 경우, Fallback 로직을 실행한다.
    -   **상태 유지:** 설정된 대기 시간(`waitDurationInOpenState`) 동안 `OPEN` 상태를 유지한다.
    -   **전환 조건:** 대기 시간이 만료되면 `HALF_OPEN` 상태로 전환된다.

-   **`HALF_OPEN` (반-열림)**
    -   **동작:** 외부 서비스의 복구 여부를 확인하기 위해, 설정된 횟수(`permittedNumberOfCallsInHalfOpenState`)만큼의 테스트 요청을 허용한다.
    -   **상태 유지:** 테스트 요청의 성공/실패 결과를 기록한다.
    -   **전환 조건:**
        -   테스트 요청의 실패율이 임계값을 넘지 않으면 `CLOSED` 상태로 전환된다. (복구 성공)
        -   테스트 요청의 실패율이 임계값을 초과하면 다시 `OPEN` 상태로 전환된다. (복구 실패)

### 3. 주요 설정 파라미터 (Resilience4j 기준)

| 파라미터 | 설명 |
| :--- | :--- |
| `failure-rate-threshold` | `CLOSED` 상태에서 `OPEN`으로 전환될 실패율 임계값(%). |
| `slow-call-rate-threshold` | `CLOSED` 상태에서 `OPEN`으로 전환될 느린 호출 비율 임계값(%). |
| `slow-call-duration-threshold` | 호출 시간이 이 값을 초과하면 '느린 호출'로 간주되는 시간 기준. |
| `wait-duration-in-open-state` | `OPEN` 상태를 유지하는 시간. 이 시간이 지나면 `HALF_OPEN`으로 전환. |
| `sliding-window-type` | 실패율 집계 방식. `COUNT_BASED`(호출 수) 또는 `TIME_BASED`(시간). |
| `sliding-window-size` | 실패율을 집계할 윈도우의 크기 (호출 수 또는 시간(초)). |
| `minimum-number-of-calls` | 실패율 계산을 시작하기 위한 최소 호출 수. |
| `permitted-number-of-calls-in-half-open-state` | `HALF_OPEN` 상태에서 허용되는 테스트 호출의 수. |

### 4. Spring Boot & Feign Client 적용 절차

1.  **의존성 추가**: `spring-cloud-starter-circuitbreaker-resilience4j` 의존성을 프로젝트에 추가한다.
2.  **설정 활성화**: `@EnableFeignClients` 어노테이션을 설정하고, `application.yml`에 `feign.circuitbreaker.enabled: true`를 추가한다.
3.  **정책 정의**: `application.yml`의 `resilience4j.circuitbreaker.instances` 하위에 각 서킷 브레이커 인스턴스에 대한 상세 정책(상기 파라미터)을 정의한다.
4.  **Fallback 구현**: 실패 시 대체 로직을 수행할 Fallback 클래스를 작성한다. 이 클래스는 `@Component`로 선언되고 대상 `FeignClient` 인터페이스를 구현해야 한다.
5.  **적용**: `@FeignClient` 어노테이션에 `fallback` 속성으로 구현한 Fallback 클래스를 지정하고, 호출 메소드에 `@CircuitBreaker(name="...")` 어노테이션을 추가하여 `yml`에 정의된 정책을 연결한다.

### 5. 핵심 효과

-   **장애 격리 (Failure Isolation)**: 특정 외부 서비스의 장애가 호출 클라이언트로 전파되는 것을 차단한다.
-   **빠른 실패 (Fail Fast)**: 이미 장애 상태인 서비스에 불필요한 요청을 보내 응답을 기다리는 자원 낭비를 막고 즉시 실패를 반환한다.
-   **우아한 성능 저하 (Graceful Degradation)**: Fallback 메커니즘을 통해 전체 기능 실패 대신 부분적인 성공 또는 대체 응답을 제공하여 서비스의 가용성을 높인다.